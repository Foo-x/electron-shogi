import {
  Color,
  importKakinoki,
  Move,
  Piece,
  PieceType,
  Record,
  RecordMetadataKey,
  SpecialMove,
  Square,
} from "@/shogi";

describe("shogi/kakinoki", () => {
  it("import/standard", () => {
    const data = `
# ----  Kifu for Windows V7 V7.50 棋譜ファイル  ----
手合割：平手　　
先手：奨励会員
後手：久保
手数----指手---------消費時間--
   1 ２六歩(27)   ( 0:00/00:00:00)
   2 ８四歩(83)   ( 0:00/00:00:00)
   3 ７六歩(77)   ( 0:00/00:00:00)
   4 ８五歩(84)   ( 0:00/00:00:00)
   5 ７七角(88)   ( 0:00/00:00:00)
   6 ３二金(41)   ( 0:00/00:00:00)
   7 ６八銀(79)   ( 0:00/00:00:00)
   8 ３四歩(33)   ( 0:00/00:00:00)
   9 ７八金(69)   ( 0:00/00:00:00)
  10 ４二銀(31)   ( 0:00/00:00:00)
  11 ４八銀(39)   ( 0:00/00:00:00)
  12 ６二銀(71)   ( 0:00/00:00:00)
  13 ４六歩(47)   ( 0:00/00:00:00)
  14 ６四歩(63)   ( 0:00/00:00:00)
  15 ４七銀(48)   ( 0:00/00:00:00)
  16 ６三銀(62)   ( 0:00/00:00:00)
  17 ２二角成(77) ( 0:00/00:00:00)
  18 同　金(32)   ( 0:00/00:00:00)
  19 ７七銀(68)   ( 0:00/00:00:00)
  20 ４四歩(43)   ( 0:00/00:00:00)
  21 ９六歩(97)   ( 0:00/00:00:00)
  22 ９四歩(93)   ( 0:00/00:00:00)
  23 ３六歩(37)   ( 0:00/00:00:00)
  24 ４三銀(42)   ( 0:00/00:00:00)
  25 ３七桂(29)   ( 0:00/00:00:00)
  26 ５二金(61)   ( 0:00/00:00:00)
  27 ４八金(49)   ( 0:00/00:00:00)
  28 ７四歩(73)   ( 0:00/00:00:00)
  29 ６六歩(67)   ( 0:00/00:00:00)
  30 ７三桂(81)   ( 0:00/00:00:00)
  31 ２九飛(28)   ( 0:00/00:00:00)
  32 ８一飛(82)   ( 0:00/00:00:00)
  33 ６八銀(77)   ( 0:00/00:00:00)
  34 ４二玉(51)   ( 0:00/00:00:00)
  35 ６七銀(68)   ( 0:00/00:00:00)
  36 ８六歩(85)   ( 0:00/00:00:00)
  37 同　歩(87)   ( 0:00/00:00:00)
  38 同　飛(81)   ( 0:00/00:00:00)
  39 ８七歩打     ( 0:00/00:00:00)
  40 ８一飛(86)   ( 0:00/00:00:00)
  41 ４九玉(59)   ( 0:00/00:00:00)
  42 １四歩(13)   ( 0:00/00:00:00)
  43 ３八玉(49)   ( 0:00/00:00:00)
  44 １五歩(14)   ( 0:00/00:00:00)
  45 ５六銀(67)   ( 0:00/00:00:00)
  46 ３二金(22)   ( 0:00/00:00:00)
  47 ６九飛(29)   ( 0:00/00:00:00)
  48 ３一玉(42)   ( 0:00/00:00:00)
  49 ７七桂(89)   ( 0:00/00:00:00)
  50 ５四銀(43)   ( 0:00/00:00:00)
  51 ６五歩(66)   ( 0:00/00:00:00)
  52 同　桂(73)   ( 0:00/00:00:00)
  53 同　桂(77)   ( 0:00/00:00:00)
  54 同　歩(64)   ( 0:00/00:00:00)
  55 ４五歩(46)   ( 0:00/00:00:00)
  56 ７三角打     ( 0:00/00:00:00)
  57 ６五銀(56)   ( 0:00/00:00:00)
  58 同　銀(54)   ( 0:00/00:00:00)
  59 同　飛(69)   ( 0:00/00:00:00)
  60 ５四銀(63)   ( 0:00/00:00:00)
  61 ７二角打     ( 0:00/00:00:00)
  62 ６五銀(54)   ( 0:00/00:00:00)
  63 ８一角成(72) ( 0:00/00:00:00)
  64 ２二玉(31)   ( 0:00/00:00:00)
*4六桂の方が良かった。
  65 ４一銀打     ( 0:00/00:00:00)
  66 ６九飛打     ( 0:00/00:00:00)
  67 ７九飛打     ( 0:00/00:00:00)
  68 ２九銀打     ( 0:00/00:00:00)
  69 ２八玉(38)   ( 0:00/00:00:00)
  70 ７九飛成(69) ( 0:00/00:00:00)
  71 同　金(78)   ( 0:00/00:00:00)
  72 １六歩(15)   ( 0:00/00:00:00)
  73 ２九玉(28)   ( 0:00/00:00:00)
  74 １七歩成(16) ( 0:00/00:00:00)
  75 同　香(19)   ( 0:00/00:00:00)
  76 同　香成(11) ( 0:00/00:00:00)
  77 １四桂打     ( 0:00/00:00:00)
  78 ３三玉(22)   ( 0:00/00:00:00)
  79 ３二銀成(41) ( 0:00/00:00:00)
  80 同　玉(33)   ( 0:00/00:00:00)
  81 １二飛打     ( 0:00/00:00:00)
  82 ４一玉(32)   ( 0:00/00:00:00)
  83 ３一金打     ( 0:00/00:00:00)
  84 ５一玉(41)   ( 0:00/00:00:00)
  85 ５二飛成(12) ( 0:00/00:00:00)
  86 同　玉(51)   ( 0:00/00:00:00)
  87 ４一銀打     ( 0:00/00:00:00)
  88 ４三玉(52)   ( 0:00/00:00:00)
  89 ４四歩(45)   ( 0:00/00:00:00)
  90 ３三玉(43)   ( 0:00/00:00:00)
  91 ３二銀成(41) ( 0:00/00:00:00)
  92 ２四玉(33)   ( 0:00/00:00:00)
  93 ２五金打     ( 0:00/00:00:00)
  94 １三玉(24)   ( 0:00/00:00:00)
`;
    const record = importKakinoki(data) as Record;
    expect(record).toBeInstanceOf(Record);
    expect(
      record.metadata.getStandardMetadata(RecordMetadataKey.BLACK_NAME)
    ).toBe("奨励会員");
    expect(
      record.metadata.getStandardMetadata(RecordMetadataKey.WHITE_NAME)
    ).toBe("久保");
    expect(record.current.comment).toBe("");
    record.goto(64);
    expect(record.current.comment).toBe("4六桂の方が良かった。");
    expect(record.sfen).toBe(
      "sfen l+B5nl/4g1gk1/2b1p2p1/p1p2pp2/3s1P2p/P1P3PP1/1P2PSN1P/2G2GK2/L7L b RSNPrsn2p 65"
    );
    record.goto(999);
    expect(record.current.number).toBe(94);
    expect(record.current.comment).toBe("");
  });

  it("import/handicap", () => {
    const data = `
#KIF version=2.0 encoding=UTF-8
開始日時：2021/10/17
場所：81Dojo
持ち時間：15分+60秒
手合割：角落ち
先手：ZhangJingding
後手：Sota_FUJII
手数----指手---------消費時間--
1   ８四歩(83)   (0:23/0:0:23)
2   ７六歩(77)   (0:29/0:0:29)
3   ８五歩(84)   (0:3/0:0:26)
4   ７七角(88)   (0:2/0:0:31)
5   ６二銀(71)   (0:4/0:0:30)
6   ８八銀(79)   (0:3/0:0:34)
7   ４二玉(51)   (0:8/0:0:38)
8   ２六歩(27)   (0:4/0:0:38)
9   ２二銀(31)   (0:3/0:0:41)
10   ２五歩(26)   (0:7/0:0:45)
11   ３二玉(42)   (0:6/0:0:47)
12   ７八金(69)   (0:4/0:0:49)
13   ７四歩(73)   (0:7/0:0:54)
14   ５八金(49)   (0:3/0:0:52)
15   ５二金(61)   (0:11/0:1:5)
16   ６六歩(67)   (0:5/0:0:57)
17   ６四歩(63)   (0:16/0:1:21)
18   ６七金(58)   (0:4/0:1:1)
19   ６三銀(62)   (0:2/0:1:23)
20   ５六歩(57)   (0:3/0:1:4)
21   ７二飛(82)   (0:19/0:1:42)
22   ６八角(77)   (0:5/0:1:9)
23   ７五歩(74)   (0:3/0:1:45)
24   同　歩(76)   (0:3/0:1:12)
25   同　飛(72)   (0:2/0:1:47)
26   ７六歩打   (0:2/0:1:14)
27   ７四飛(75)   (0:16/0:2:3)
28   ７七銀(88)   (0:4/0:1:18)
29   ４二金(41)   (0:11/0:2:14)
30   ４八銀(39)   (0:2/0:1:20)
31   ３四歩(33)   (0:2/0:2:16)
32   ３六歩(37)   (0:9/0:1:29)
33   ３三銀(22)   (0:3/0:2:19)
34   ６九玉(59)   (0:3/0:1:32)
35   ４四歩(43)   (0:24/0:2:43)
36   ７九玉(69)   (0:6/0:1:38)
37   ７三桂(81)   (0:15/0:2:58)
38   ３七銀(48)   (0:10/0:1:48)
39   ８四飛(74)   (0:4/0:3:2)
40   ２六銀(37)   (0:16/0:2:4)
41   ８一飛(84)   (0:12/0:3:14)
42   ３五歩(36)   (0:17/0:2:21)
43   同　歩(34)   (0:9/0:3:23)
44   同　銀(26)   (0:1/0:2:22)
45   ４三金(42)   (0:3/0:3:26)
46   ２四歩(25)   (0:21/0:2:43)
47   同　歩(23)   (0:4/0:3:30)
48   同　銀(35)   (0:1/0:2:44)
49   同　銀(33)   (0:2/0:3:32)
50   同　角(68)   (0:1/0:2:45)
51   ２三歩打   (0:4/0:3:36)
52   ６八角(24)   (0:4/0:2:49)
53   ５四歩(53)   (0:12/0:3:48)
54   ８八玉(79)   (0:11/0:3:0)
55   ３三金(43)   (0:19/0:4:7)
56   ２五銀打   (0:37/0:3:37)
57   ４三金(52)   (1:3/0:5:10)
58   ３四歩打   (0:38/0:4:15)
59   同　金(43)   (0:5/0:5:15)
60   同　銀(25)   (0:3/0:4:18)
61   同　金(33)   (0:2/0:5:17)
62   ６二金打   (0:6/0:4:24)
63   ５二銀打   (1:56/0:7:13)
64   ５五歩(56)   (0:5/0:4:29)
65   ５三銀打   (0:27/0:7:40)
66   ５二金(62)   (0:19/0:4:48)
67   同　銀(63)   (0:2/0:7:42)
68   ７五歩(76)   (1:33/0:6:21)
69   ６三銀(52)   (0:46/0:8:28)
70   ７四銀打   (0:10/0:6:31)
71   ７二銀(63)   (0:12/0:8:40)
72   ５四歩(55)   (0:21/0:6:52)
73   同　銀(53)   (0:3/0:8:43)
74   ７三銀成(74)   (0:2/0:6:54)
75   同　銀(72)   (0:2/0:8:45)
76   ４六桂打   (0:1/0:6:55)
77   ４五銀打   (2:16/0:11:1)
78   ３四桂(46)   (0:41/0:7:36)
79   同　銀(45)   (0:2/0:11:3)
80   ５三金打   (0:1/0:7:37)
81   ４三金打   (0:16/0:11:19)
82   同　金(53)   (0:30/0:8:7)
83   同　銀(54)   (0:36/0:11:55)
84   ７二金打   (0:2/0:8:9)
85   ８三飛(81)   (0:3/0:11:58)
86   ２四歩打   (0:30/0:8:39)
87   同　歩(23)   (0:47/0:12:45)
88   同　角(68)   (0:2/0:8:41)
89   ３三桂(21)   (0:37/0:13:22)
90   ７三金(72)   (0:41/0:9:22)
91   同　飛(83)   (0:4/0:13:26)
92   ４一銀打   (0:1/0:9:23)
93   ４二玉(32)   (0:13/0:13:39)
94   ４六角(24)   (0:59/0:10:22)
95   ４一玉(42)   (0:29/0:14:8)
96   ６四角(46)   (0:1/0:10:23)
97   ２七歩打   (0:12/0:14:20)
98   同　飛(28)   (0:16/0:10:39)
99   ２六歩打   (0:2/0:14:22)
100   同　飛(27)   (0:9/0:10:48)
101   ２五歩打   (0:1/0:14:23)
102   ５六飛(26)   (0:1/0:10:49)
103   ６三飛(73)   (0:27/0:14:50)
104   ９一角成(64)   (0:21/0:11:10)
105   ７六歩打   (0:7/0:14:57)
106   ６八銀(77)   (0:6/0:11:16)
107   ８六歩(85)   (0:39/0:15:36)
108   同　歩(87)   (0:20/0:11:36)
109   ４五銀(34)   (0:38/0:16:14)
110   ５九飛(56)   (0:12/0:11:48)
111   ４八金打   (0:14/0:16:28)
112   ８一馬(91)   (0:32/0:12:20)
113   ８三飛(63)   (0:22/0:16:50)
114   ７二馬(81)   (0:22/0:12:42)
115   ８六飛(83)   (0:12/0:17:2)
116   ８七歩打   (0:21/0:13:3)
117   ５九金(48)   (0:9/0:17:11)
118   同　銀(68)   (0:9/0:13:12)
119   ９五桂打   (0:40/0:17:51)
120   ８六歩(87)   (0:6/0:13:18)
121   ８七歩打   (0:15/0:18:6)
122   同　金(78)   (0:17/0:13:35)
123   ６九飛打   (0:21/0:18:27)
124   ８一飛打   (0:28/0:14:3)
125   ５一歩打   (0:28/0:18:55)
126   ６八銀(59)   (0:6/0:14:9)
127   ７九銀打   (0:45/0:19:40)
128   同　銀(68)   (0:5/0:14:14)
129   ６七飛成(69)   (0:7/0:19:47)
130   ７八金打   (0:14/0:14:28)
131   ８七桂成(95)   (0:24/0:20:11)
132   同　金(78)   (0:1/0:14:29)
133   ６八金打   (0:25/0:20:36)
134   ６一馬(72)   (1:16/0:15:45)
135   ５八龍(67)   (0:40/0:21:16)
136   ５一馬(61)   (0:43/0:16:28)
137   同　龍(58)   (0:22/0:21:38)
138   同　飛成(81)   (0:3/0:16:31)
139   同　玉(41)   (0:19/0:21:57)
140   ６八銀(79)   (0:1/0:16:32)
141   ２八飛打   (0:28/0:22:25)
142   ５九香打   (0:36/0:17:8)
143   ４一玉(51)   (0:23/0:22:48)
144   ５一飛打   (0:19/0:17:27)
145   ３二玉(41)   (0:16/0:23:4)
146   ７八金打   (0:19/0:17:46)
147   ３五角打   (0:18/0:23:22)
148   ４六桂打   (0:15/0:18:1)
149   ６九金打   (0:40/0:24:2)
150   ５八飛成(51)   (0:34/0:18:35)
151   同　飛成(28)   (0:14/0:24:16)
152   同　香(59)   (0:1/0:18:36)
153   ２八飛打   (0:9/0:24:25)
154   ５九歩打   (0:26/0:19:2)
155   ２九飛成(28)   (0:44/0:25:9)
156   ５三香成(58)   (0:55/0:19:57)
157   ６八金(69)   (0:19/0:25:28)
158   同　金(78)   (0:3/0:20:0)
159   ５九龍(29)   (0:8/0:25:36)
160   ４三成香(53)   (0:10/0:20:10)
161   同　玉(32)   (0:9/0:25:45)
162   ６九金打   (0:2/0:20:12)
163   ５六龍(59)   (0:44/0:26:29)
164   ５三歩打   (0:53/0:21:5)
165   ４六銀(45)   (0:19/0:26:48)
166   同　歩(47)   (0:10/0:21:15)
167   ９五桂打   (0:23/0:27:11)
168   ５二銀打   (0:37/0:21:52)
169   ５三玉(43)   (0:39/0:27:50)
170   ８三飛打   (0:4/0:21:56)
171   ５二玉(53)   (0:14/0:28:4)
172   ４三銀打   (0:9/0:22:5)
173   ６一玉(52)   (0:12/0:28:16)
174   ６三飛成(83)   (0:9/0:22:14)
175   ６二歩打   (0:16/0:28:32)
176   ７二銀打   (0:19/0:22:33)
177   ５一玉(61)   (0:10/0:28:42)
178   投了   (0:11/0:22:44)
`;
    const record = importKakinoki(data) as Record;
    expect(record).toBeInstanceOf(Record);
    expect(
      record.metadata.getStandardMetadata(RecordMetadataKey.BLACK_NAME)
    ).toBe("ZhangJingding");
    expect(
      record.metadata.getStandardMetadata(RecordMetadataKey.WHITE_NAME)
    ).toBe("Sota_FUJII");
    expect(record.position.board.at(new Square(2, 2))).toBeNull();
    expect(record.position.board.at(new Square(8, 2))).toStrictEqual(
      new Piece(Color.WHITE, PieceType.ROOK)
    );
    record.goto(104);
    const move = record.current.move as Move;
    expect(move.getDisplayText()).toBe("▲９一角成(64)");
    expect(record.current.elapsedMs).toBe(21000);
    expect(record.current.totalElapsedMs).toBe(670000);
    record.goto(999);
    expect(record.current.number).toBe(178);
    expect(record.current.move).toBe(SpecialMove.RESIGN);
    expect(record.current.elapsedMs).toBe(11000);
    expect(record.current.totalElapsedMs).toBe(1364000);
  });
});
